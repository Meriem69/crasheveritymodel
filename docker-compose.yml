version: "3.8"

# =============================================================================
# Docker Compose — MLflow Tracking Server
# =============================================================================
# Lance le serveur MLflow dans un conteneur Docker.
# Les données (runs, modèles, artefacts) sont persistées via un volume.
#
# Lancement : docker-compose up --build
# Arrêt     : docker-compose down
# Interface : http://localhost:5000
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # SERVICE : Serveur MLflow
  # ---------------------------------------------------------------------------
  # MLflow est lancé comme un service Docker indépendant.
  # Il stocke ses données dans un fichier SQLite (mlflow.db)
  # et ses artefacts dans un dossier local (mlartifacts/).
  # ---------------------------------------------------------------------------
  mlflow:
    image: python:3.11-slim

    container_name: mlflow_server

    # Installe MLflow et lance le serveur au démarrage du conteneur
    command: >
      bash -c "pip install mlflow -q &&
               mlflow server
               --host 0.0.0.0
               --port 5000
               --backend-store-uri sqlite:///mlflow/mlflow.db
               --default-artifact-root /mlflow/mlartifacts"

    ports:
      - "5000:5000"                          # Interface accessible sur http://localhost:5000

    volumes:
      # Volume persistant : les données MLflow survivent aux redémarrages
      - mlflow_data:/mlflow

    healthcheck:
      # Vérifie que le serveur MLflow répond correctement
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# VOLUMES — Données persistantes
# =============================================================================
volumes:
  mlflow_data:
    driver: local
